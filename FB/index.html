<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fatty Bird ‚Äî Home</title>
  <style>
    :root{ --bg:#0e1b2a; --fg:#e8f0fe; --muted:#9fb3c8; --accent:#52d67a; --card:#122033; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#1b2a41, #0e1b2a); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;}
    .container{max-width:920px; margin:24px auto; padding:0 16px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{margin:0; font-size:clamp(22px,3vw,32px)}
    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px}
    .card{background:var(--card); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:0; border-radius:999px; padding:.6rem 1rem; font-weight:700; color:#00121f; background:var(--accent); box-shadow:0 8px 18px rgba(82,214,122,.35); cursor:pointer}
    .btn:active{transform:translateY(1px)}
    a.btn{display:inline-flex; align-items:center; text-decoration:none}
    table{width:100%; border-collapse:collapse; margin-top:12px}
    th,td{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08)}
    th{font-weight:700; text-align:left; color:#cfe1ff}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    input[type=text]{background:#0c1726; color:var(--fg); border:1px solid #274160; border-radius:10px; padding:8px 10px}
    .pill{background:#0c1726; border-radius:999px; padding:4px 10px; color:#cfe1ff}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üê¶ Fatty Bird ‚Äî Home</h1>
      <a id="playBtn" href="fattybird.html" class="btn" title="Launch the game">Play</a>
    </header>

    <section class="cards">
      <div class="card">
        <h2 style="margin-top:0">Site Stats</h2>
        <div class="row" style="margin-top:8px">
          <div class="pill">Homepage Views: <span id="homeViews">‚Äî</span></div>
          <div class="pill">Homepage Unique Visitors: <span id="homeUniques">‚Äî</span></div>
          <div class="pill">Total Plays: <span id="totalPlays">‚Äî</span></div>
        </div>
        <p class="muted" style="margin-top:8px">‚ÄúUnique visitors‚Äù ‚âà unique per device/browser (uses localStorage).</p>
      </div>

      <div class="card">
        <h2 style="margin-top:0">Leaderboard</h2>
        <div class="row" style="gap:8px; margin-top:8px">
          <input id="playerName" type="text" placeholder="Your name" maxlength="24"/>
          <button id="submitBest" class="btn">Submit Device Best</button>
          <button id="refreshLB" class="btn">Refresh</button>
          <span class="right muted">Device Best: <span id="deviceBest">0</span></span>
        </div>
        <table>
          <thead>
            <tr><th style="width:64px">#</th><th>Name</th><th>Score</th><th>Date</th></tr>
          </thead>
          <tbody id="lbBody"><tr><td colspan="4" class="muted">Loading‚Ä¶</td></tr></tbody>
        </table>
        <p class="muted" style="margin-top:8px">Tip: click <b>Submit Device Best</b> after you set a high score in the game. The game stores your best in localStorage.</p>
      </div>

      <div class="card">
        <h2 style="margin-top:0">About</h2>
        <p>This is the Fatty Bird hub. Use <b>Play</b> to launch the game, track total plays, and post your best score to the leaderboard.</p>
        <p class="muted">Want a global leaderboard shared across all visitors? See the code comment for <b>BACKEND_URL</b> ‚Äî plug in a simple Apps Script or Worker endpoint and you‚Äôre done.</p>
      </div>
    </section>
  </div>

  <script>
  "use strict";
  // ========= CONFIG =========
  // CountAPI namespace (change to something unique for your site)
  const COUNT_NS = 'statslg-fattybird-001';
  // Optional: backend endpoint for a GLOBAL leaderboard.
  // If left empty, we fall back to a local (this-device) leaderboard stored in localStorage.
  // Expected API:
  //   GET  BACKEND_URL + '/top?limit=10' -> [{name, score, ts}] sorted desc
  //   POST BACKEND_URL + '/score' JSON {name, score} -> {ok:true}
  const BACKEND_URL = '';

  // ========= COUNTERS =========
  const pvEl = document.getElementById('homeViews');
  const uvEl = document.getElementById('homeUniques');
  const playsEl = document.getElementById('totalPlays');
  const UV_KEY = 'fatty_home_uv_seen';

  function fmt(n){ return (n??0).toLocaleString(); }
  function setText(el, v){ if(el) el.textContent = v; }

  function updateCounters(){
    // Always increment homepage views
    fetch(`https://api.countapi.xyz/hit/${COUNT_NS}/homeviews`).then(r=>r.json()).then(d=>setText(pvEl, fmt(d.value))).catch(()=>setText(pvEl,'n/a'));

    // Uniques per device/browser
    const uniqueEndpoint = localStorage.getItem(UV_KEY) ? 'get' : 'hit';
    fetch(`https://api.countapi.xyz/${uniqueEndpoint}/${COUNT_NS}/homeuniques`).then(r=>r.json()).then(d=>{
      setText(uvEl, fmt(d.value));
      localStorage.setItem(UV_KEY,'1');
    }).catch(()=>setText(uvEl,'n/a'));

    // Get total plays (do not increment here; we increment when user clicks Play)
    fetch(`https://api.countapi.xyz/get/${COUNT_NS}/plays`).then(r=>r.json()).then(d=>setText(playsEl, fmt(d.value||0))).catch(()=>setText(playsEl,'n/a'));
  }

  // Increment plays when the Play button is clicked (fire-and-forget)
  const playBtn = document.getElementById('playBtn');
  if(playBtn){
    playBtn.addEventListener('click', function(){
      fetch(`https://api.countapi.xyz/hit/${COUNT_NS}/plays`).catch(()=>{});
    });
  }

  // ========= LEADERBOARD =========
  const deviceBestEl = document.getElementById('deviceBest');
  const lbBody = document.getElementById('lbBody');
  const nameInput = document.getElementById('playerName');
  const submitBtn = document.getElementById('submitBest');
  const refreshBtn = document.getElementById('refreshLB');

  function getDeviceBest(){
    const best = +(localStorage.getItem('best_flappy') || '0');
    deviceBestEl.textContent = String(best);
    return best;
  }

  function renderRows(rows){
    lbBody.innerHTML = '';
    if(!rows || !rows.length){ lbBody.innerHTML = '<tr><td colspan="4" class="muted">No scores yet.</td></tr>'; return; }
    rows.slice(0,10).forEach((r, i)=>{
      const tr = document.createElement('tr');
      const date = new Date(r.ts || Date.now());
      tr.innerHTML = `<td>${i+1}</td><td>${(r.name||'‚Äî')}</td><td>${r.score}</td><td>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</td>`;
      lbBody.appendChild(tr);
    });
  }

  // ===== Local (fallback) leaderboard =====
  function getLocalLB(){
    try { return JSON.parse(localStorage.getItem('lb_local')||'[]'); } catch { return []; }
  }
  function setLocalLB(arr){ localStorage.setItem('lb_local', JSON.stringify(arr)); }
  function upsertLocal(name, score){
    const arr = getLocalLB();
    const now = Date.now();
    const idx = arr.findIndex(x=> (x.name||'').toLowerCase() === (name||'').toLowerCase());
    if(idx>=0){ if(score > +arr[idx].score){ arr[idx] = {name, score:+score, ts: now}; } }
    else { arr.push({name, score:+score, ts: now}); }
    arr.sort((a,b)=>b.score-a.score);
    setLocalLB(arr.slice(0,100));
    return arr;
  }

  async function loadLeaderboard(){
    if(BACKEND_URL){
      try{
        const res = await fetch(`${BACKEND_URL}/top?limit=10`, {cache:'no-store'});
        const data = await res.json();
        renderRows(Array.isArray(data)? data : []);
        return;
      }catch(e){ console.warn('Backend fetch failed, using local LB', e); }
    }
    renderRows(getLocalLB());
  }

  async function submitScore(){
    const name = (nameInput.value||'').trim() || 'Anonymous';
    const score = getDeviceBest();
    if(!score){ alert('You have no device best yet. Play the game first!'); return; }

    if(BACKEND_URL){
      try{
        await fetch(`${BACKEND_URL}/score`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, score})});
      }catch(e){ console.warn('Backend submit failed, storing locally', e); upsertLocal(name, score); }
    } else {
      upsertLocal(name, score);
    }
    await loadLeaderboard();
    alert('Score submitted!');
  }

  // Wire up
  submitBtn?.addEventListener('click', submitScore);
  refreshBtn?.addEventListener('click', loadLeaderboard);

  // Init
  updateCounters();
  getDeviceBest();
  loadLeaderboard();

  // ========= OPTIONAL: Cloud / Apps Script backend =========
  /*
  QUICK Google Apps Script backend (Spreadsheet-based, public read, tokenless write for simplicity ‚Äî restrict as you see fit):

  1) Go to https://script.google.com > New project. Paste this code and deploy as Web App (Execute as: Me; Who has access: Anyone).

  const SHEET_NAME = 'Scores';
  function _sheet(){
    const ss = SpreadsheetApp.getActive();
    let sh = ss.getSheetByName(SHEET_NAME);
    if(!sh){ sh = ss.insertSheet(SHEET_NAME); sh.appendRow(['name','score','ts']); }
    return sh;
  }
  function doPost(e){
    const body = JSON.parse(e.postData.contents || '{}');
    const name = String(body.name||'Anonymous').slice(0,24);
    const score = Number(body.score||0) | 0;
    if(score>0){ _sheet().appendRow([name, score, Date.now()]); }
    return ContentService.createTextOutput(JSON.stringify({ok:true})).setMimeType(ContentService.MimeType.JSON);
  }
  function doGet(e){
    const limit = Math.min(50, Number(e.parameter.limit||10));
    const rows = _sheet().getDataRange().getValues().slice(1).map(r=>({name:r[0], score:Number(r[1])||0, ts:Number(r[2])||Date.now()}));
    rows.sort((a,b)=>b.score-a.score);
    return ContentService.createTextOutput(JSON.stringify(rows.slice(0,limit))).setMimeType(ContentService.MimeType.JSON);
  }

  2) Copy the deployment URL and set BACKEND_URL to that URL (no trailing slash required).
  */
  </script>
</body>
</html>