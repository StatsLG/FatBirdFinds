<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Prevent stale caching during development/testing -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fatty Bird Flies Home</title>
  <style>
    :root{ --bg:#0e1b2a; --fg:#e8f0fe; --muted:#9fb3c8; --accent:#52d67a; --card:#122033; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#1b2a41, #0e1b2a); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;}
    .container{max-width:920px; margin:24px auto; padding:0 16px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{margin:0; font-size:clamp(22px,3vw,32px)}
    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px}
    .card{background:var(--card); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:0; border-radius:999px; padding:.6rem 1rem; font-weight:700; color:#00121f; background:var(--accent); box-shadow:0 8px 18px rgba(82,214,122,.35); cursor:pointer}
    .btn:active{transform:translateY(1px)}
    a.btn{display:inline-flex; align-items:center; text-decoration:none}
    table{width:100%; border-collapse:collapse; margin-top:12px}
    th,td{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08)}
    th{font-weight:700; text-align:left; color:#cfe1ff}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    input[type=text]{background:#0c1726; color:var(--fg); border:1px solid #274160; border-radius:10px; padding:8px 10px}
    .pill{background:#0c1726; border-radius:999px; padding:4px 10px; color:#cfe1ff}
    .hero{ text-align:center; margin:8px 0 10px }
    .logo{ width:min(220px, 50vw); height:auto; display:block; margin:0 auto 6px }
    .site-title{ margin:0; font-size:clamp(28px,6vw,48px); line-height:1.1 }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <img id="logo" alt="Fatty Bird logo" class="logo" src="fbflogo.png" />
      <h1 class="site-title">Fatty Bird</h1>
    </div>

    <header>
      <button id="resetBtn" class="btn" title="Clear localStorage & caches for this site" style="background:#ffb703;color:#00121f;display:none">Reset Site Data</button>
      <a id="playBtn" href="fattybird.html" class="btn" title="Launch the game">Play</a>
      <span id="buildTag" class="muted"></span>
      <span id="backendStatus" class="muted"></span>
    </header>


      <div class="card">
        <h2 style="margin-top:0">Leaderboard</h2>
        <div class="row" style="gap:8px; margin-top:8px">
          <input id="playerName" type="text" placeholder="Your name" maxlength="24"/>
          <button id="submitBest" class="btn">Submit Device Best</button>
          <button id="refreshLB" class="btn">Refresh</button>
          <span class="right muted">Device Best: <span id="deviceBest">0</span></span>
        </div>
        <table>
          <thead>
            <tr><th style="width:64px">#</th><th>Name</th><th>Score</th><th>Date</th></tr>
          </thead>
          <tbody id="lbBody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
        </table>
        <p class="muted" style="margin-top:8px">Tip: click <b>Submit Device Best</b> after you set a high score in the game.</p>
      </div>

      <div class="card">
        <h2 style="margin-top:0">About</h2>
        <p>This is the Fatty Bird hub. Use <b>Play</b> to launch the game and post your best score to the leaderboard.</p>
        <p class="muted">This game was developed by an amateur programmer for the use of the Fat Bird Finds community. It is intended for lighthearted fun and not to be taked too seriously. Please do not ruin the fun for others!</p>
      </div>

          <section class="cards">
      <div class="card">
        <h2 style="margin-top:0">Site Stats</h2>
        <div class="row" style="margin-top:8px">
          <div class="pill">Homepage Views: <span id="homeViews">—</span></div>
          <div class="pill">Homepage Unique Visitors: <span id="homeUniques">—</span></div>
          <div class="pill">Total Plays: <span id="totalPlays">—</span></div>
        </div>
      </div>
    </section>
  </div>

  <script>
  "use strict";
  // ========= VERSION & MODE =========
  const VERSION = '1.0.4'; // bump after each deploy to bust caches
  function isDev(){
    const host = location.hostname;
    let qs; try { qs = new URLSearchParams(location.search); } catch { qs = { has: ()=>false }; }
    return host === 'localhost' || host === '127.0.0.1' || qs.has('dev');
  }

  // ========= CONFIG =========
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwoZ8_K9itPH9e9tbUprW4cSeRzZcEu6x6rHZlGQjx-xT5qsbOV7Uvfk08KagoHkH1g/exec';

  // ========= UTILS =========
  function fmt(n){ return (n??0).toLocaleString(); }
  function setText(el, v){ if(el) el.textContent = v; }

  // ========= STATS COUNTERS (POST to backend) =========
  const pvEl = document.getElementById('homeViews');
  const uvEl = document.getElementById('homeUniques');
  const playsEl = document.getElementById('totalPlays');
  const backendStatus = document.getElementById('backendStatus');
  const UV_KEY = 'fatty_home_uv_seen';

  async function backendCounter(op, key){
    try{
      const res = await fetch(BACKEND_URL, {
        method: 'POST',
        body: new URLSearchParams({ m:'1', op, k:key }) // form-encoded, no preflight
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json(); // {value: N}
      backendStatus && (backendStatus.textContent = ' · Leaderboard: connected');
      return Number((data && data.value) || 0);
    }catch(e){
      // Fire-and-forget in case of blockers; still increments server counters
      try { await fetch(BACKEND_URL, { method:'POST', mode:'no-cors', body: new URLSearchParams({ m:'1', op, k:key }) }); } catch {}
      throw e;
    }
  }

  function updateCounters(){
    backendCounter('hit','homeviews').then(v=>setText(pvEl, fmt(v))).catch(()=>setText(pvEl,'n/a'));

    const uniqueOp = localStorage.getItem(UV_KEY) ? 'get' : 'hit';
    backendCounter(uniqueOp,'homeuniques')
      .then(v=>{ setText(uvEl, fmt(v)); localStorage.setItem(UV_KEY,'1'); })
      .catch(()=>setText(uvEl,'n/a'));

    backendCounter('get','plays').then(v=>setText(playsEl, fmt(v))).catch(()=>setText(playsEl,'n/a'));
  }

  // ========= PLAY BUTTON =========
  const playBtn = document.getElementById('playBtn');
  if(playBtn){
    const v = isDev() ? Date.now() : VERSION;   // cache-bust game file
    playBtn.href = `fattybird.html?v=${v}`;
    playBtn.addEventListener('click', ()=>{ backendCounter('hit','plays').catch(()=>{}); });
  }
  const buildTag = document.getElementById('buildTag');
  if(buildTag){ buildTag.textContent = `Build: ${VERSION}${isDev() ? ' (dev)' : ''}`; }

  const logoEl = document.getElementById('logo');
  if (logoEl){
    const v = isDev() ? Date.now() : VERSION;
    // If your logo is in a folder, mirror that path here
    const base = 'fbflogo.png'; // e.g., 'img/fbflogo.png'
    logoEl.src = `${base}?v=${v}`;
  }

  // ========= LEADERBOARD =========
  const deviceBestEl = document.getElementById('deviceBest');
  const lbBody = document.getElementById('lbBody');
  const nameInput = document.getElementById('playerName');
  const submitBtn = document.getElementById('submitBest');
  const refreshBtn = document.getElementById('refreshLB');

  function getDeviceBest(){
    const best = +(localStorage.getItem('best_flappy') || '0');
    deviceBestEl.textContent = String(best);
    return best;
  }

  function renderRows(rows){
    lbBody.innerHTML = '';
    if(!rows || !rows.length){ lbBody.innerHTML = '<tr><td colspan="4" class="muted">No scores yet.</td></tr>'; return; }
    rows.slice(0,10).forEach((r, i)=>{
      const tr = document.createElement('tr');
      const date = new Date(r.ts || Date.now());
      tr.innerHTML = `<td>${i+1}</td><td>${(r.name||'—')}</td><td>${r.score}</td><td>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</td>`;
      lbBody.appendChild(tr);
    });
  }

  function getLocalLB(){ try { return JSON.parse(localStorage.getItem('lb_local')||'[]'); } catch { return []; } }
  function setLocalLB(arr){ localStorage.setItem('lb_local', JSON.stringify(arr)); }
  function upsertLocal(name, score){
    const arr = getLocalLB();
    const now = Date.now();
    const idx = arr.findIndex(x=> (x.name||'').toLowerCase() === (name||'').toLowerCase());
    if(idx>=0){ if(score > +arr[idx].score){ arr[idx] = {name, score:+score, ts: now}; } }
    else { arr.push({name, score:+score, ts: now}); }
    arr.sort((a,b)=>b.score-a.score);
    setLocalLB(arr.slice(0,100));
    return arr;
  }

  async function loadLeaderboard(){
    try{
      const res = await fetch(`${BACKEND_URL}?limit=10`, {cache:'no-store'});
      const data = await res.json();
      backendStatus && (backendStatus.textContent = ' · Leaderboard: connected');
      renderRows(Array.isArray(data)? data : []);
      return;
    }catch(e){ console.warn('Leaderboard fetch failed, using local LB', e); backendStatus && (backendStatus.textContent = ' · Backend: offline'); }
    renderRows(getLocalLB());
  }

  async function submitScore(){
    const name = (nameInput.value||'').trim() || 'Anonymous';
    const score = getDeviceBest();
    if(!score){ alert('You have no device best yet. Play the game first!'); return; }
    try{
      await fetch(BACKEND_URL, { method:'POST', body:new URLSearchParams({ name, score: String(score) }) });
    }catch(e){ console.warn('Leaderboard submit failed, storing locally', e); upsertLocal(name, score); }
    await loadLeaderboard();
    alert('Score submitted!');
  }

  if(submitBtn){ submitBtn.addEventListener('click', submitScore); }
  if(refreshBtn){ refreshBtn.addEventListener('click', loadLeaderboard); }

  // ========= DEV RESET BUTTON =========
  (function(){
    const resetBtn = document.getElementById('resetBtn');
    if(!resetBtn) return;
    resetBtn.style.display = isDev() ? 'inline-block' : 'none';
    resetBtn.addEventListener('click', function(){
      try{
        localStorage.removeItem('fatty_home_uv_seen');
        localStorage.removeItem('best_flappy');
        localStorage.removeItem('lb_local');
        if('caches' in window && caches.keys){ caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))); }
        if('serviceWorker' in navigator){ navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())); }
      }catch(e){ console.warn('Reset error', e); }
      alert('Site data cleared. Reloading…');
      location.reload();
    });
  })();

  // ========= INIT =========
  updateCounters();
  getDeviceBest();
  loadLeaderboard();
  </script>
</body>
</html>
