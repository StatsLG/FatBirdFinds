<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fatty Bird — Game</title>
  <style>
    :root{
      --bg:#0e1b2a; --fg:#e8f0fe; --muted:#9fb3c8; --accent:#52d67a;
      --card:#122033; --danger:#ef476f;
    }
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#1b2a41 0%,#0e1b2a 100%); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial; display:grid; place-items:center}
    .wrap{display:flex; flex-direction:column; gap:.75rem; align-items:center}
    canvas{background:linear-gradient(180deg,#6ec1ff 0%, #bde0ff 60%, #e6f4ff 100%); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); touch-action:none}
    .hud{display:flex; gap:.5rem; align-items:center; justify-content:center; flex-wrap:wrap; opacity:.95}
    .btn{appearance:none; border:0; border-radius:999px; padding:.6rem 1rem; font-weight:700; color:#00121f; background:var(--accent); box-shadow:0 8px 18px rgba(82,214,122,.35); cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    /* Modal */
    .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.5); padding:16px; z-index:999}
    .hidden{display:none}
    .card{background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:18px; width:min(520px, 92vw)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input[type=text]{flex:1 1 220px; background:#0c1726; color:var(--fg); border:1px solid #274160; border-radius:10px; padding:8px 10px}
    .status{min-height:1.25em}
    .danger{background:var(--danger); color:#00121f}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="420" height="640" aria-label="Fatty Bird"></canvas>
    <div class="hud">
      <button id="flapBtn" class="btn" title="Space/Click/Tap to flap">Flap</button>
      <button id="restartBtn" class="btn" title="Enter to restart">Restart</button>
      <span class="muted">Controls: Space / Click / Tap · Restart: Enter</span>
    </div>
  </div>

  <!-- Game Over modal -->
  <div id="gameOver" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="goTitle">
    <div class="card">
      <h2 id="goTitle" style="margin:0 0 8px 0">Game Over</h2>
      <p style="margin:4px 0 12px 0">
        Score: <b id="goScore">0</b> · Best (device): <b id="goBest">0</b>
      </p>

      <div class="row" style="margin:8px 0">
        <input id="goName" type="text" placeholder="Your name" maxlength="24" />
        <button id="goSubmit" class="btn">Submit to Leaderboard</button>
        <button id="goSkip" class="btn danger">Skip</button>
        <span class="right muted">Submits to shared leaderboard</span>
      </div>

      <div id="goStatus" class="status muted"></div>

      <div class="row" style="margin-top:12px">
        <button id="goAgain" class="btn">Play Again</button>
      </div>
    </div>
  </div>

  <script>
  "use strict";
  // ========= CONFIG =========
  // Your global leaderboard backend (Google Apps Script Web App — ends with /exec)
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbyTeCvTQrtURE6Dd3O0SxB_qb4su9BZaSOPZHI_BsEAngGf33NFsoEGx6BRpAXn9Gw1/exec";
  // Auto-submit if we already know the player's name:
  const AUTO_SUBMIT_IF_NAME = true;

  // OPTIONAL SPRITES (leave blank to use vector art)
  const BIRD_IMG_SRC = "";   // e.g. "fbfnobg.png"
  const PIPE_IMG_SRC = "";   // e.g. "swungnobg.png"
  const BIRD_SCALE = 1.0;    // relative to default bird size
  const PIPE_SCALE_X = 1.0;  // relative to default pipe width

  // ========= CANVAS =========
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height, GROUND_H = 60;

  // ========= SPRITES =========
  const SPRITES = { bird:new Image(), pipe:new Image(), birdReady:false, pipeReady:false };
  if (BIRD_IMG_SRC) { SPRITES.bird.src = BIRD_IMG_SRC; SPRITES.bird.onload = ()=>SPRITES.birdReady=true; }
  if (PIPE_IMG_SRC) { SPRITES.pipe.src = PIPE_IMG_SRC; SPRITES.pipe.onload = ()=>SPRITES.pipeReady=true; }

  // ========= STATE =========
  const bird = { x: 90, y: H*0.4, r: 14, vy: 0 };
  const GRAVITY=0.45, FLAP=-7.6, MAX_FALL=12;
  const pipes=[], PIPE_W=66, GAP_H=160, PIPE_SPEED=2.4, SPAWN_FRAMES=95;
  let frame=0, score=0, best= +(localStorage.getItem('best_flappy')||'0'), alive=true, started=false;

  // ========= UI (modal) =========
  const modal = document.getElementById('gameOver');
  const goScore = document.getElementById('goScore');
  const goBest = document.getElementById('goBest');
  const goName = document.getElementById('goName');
  const goStatus = document.getElementById('goStatus');
  const goSubmit = document.getElementById('goSubmit');
  const goSkip = document.getElementById('goSkip');
  const goAgain = document.getElementById('goAgain');

  // Pre-fill name if saved
  goName.value = localStorage.getItem('player_name') || '';

  function showModal(curScore){
    goScore.textContent = String(curScore);
    goBest.textContent = String(best);
    goStatus.textContent = '';
    modal.classList.remove('hidden');

    // Auto-submit if name remembered
    if (AUTO_SUBMIT_IF_NAME && goName.value.trim() && BACKEND_URL) {
      submitScore(goName.value.trim(), curScore, /*silent*/true);
    }
  }
  function hideModal(){
    modal.classList.add('hidden');
  }

  async function submitScore(name, sc, silent=false){
    try{
      localStorage.setItem('player_name', name);
      goStatus.textContent = 'Submitting…';
      // GAS accepts form-encoded without custom headers
      const res = await fetch(BACKEND_URL, {
        method: 'POST',
        body: new URLSearchParams({ name, score: String(sc) })
      });
      if(!res.ok){ throw new Error('HTTP '+res.status); }
      if(!silent){ goStatus.textContent = 'Submitted ✔'; }
    }catch(e){
      if(!silent){ goStatus.textContent = 'Submit failed (will not affect your device best).'; }
      console.warn('Submit failed:', e);
    }
  }

  // ========= GAME CORE =========
  function reset(){
    pipes.length = 0;
    bird.y = H*0.45; bird.vy = 0;
    frame=0; score=0; alive=true; started=false;
    hideModal();
  }

  function spawnPipe(){
    const margin=50;
    const topHeight = Math.floor(Math.random()*(H - GROUND_H - GAP_H - margin*2)) + margin;
    pipes.push({ x: W+10, gapY: topHeight, passed:false });
  }

  function flap(){
    if(!alive){ return; }
    started = true;
    bird.vy = FLAP;
  }

  function circleIntersectsRect(cx, cy, r, rect){
    const x=rect.x, y=rect.y, w=rect.w, h=rect.h;
    const nx = Math.max(x, Math.min(cx, x+w));
    const ny = Math.max(y, Math.min(cy, y+h));
    const dx = cx - nx, dy = cy - ny;
    return (dx*dx + dy*dy) < r*r;
  }

  function update(){
    if(alive && started){
      bird.vy = Math.min(bird.vy + GRAVITY, MAX_FALL);
      bird.y += bird.vy;

      if(frame % SPAWN_FRAMES === 0) spawnPipe();
      for(let i=0;i<pipes.length;i++){ pipes[i].x -= PIPE_SPEED; }
      while(pipes.length && pipes[0].x + PIPE_W < -20){ pipes.shift(); }

      // score + best
      for(const p of pipes){
        if(!p.passed && p.x + PIPE_W < bird.x - bird.r){
          p.passed = true; score++;
          if(score > best){
            best = score; localStorage.setItem('best_flappy', String(best));
          }
        }
      }

      // walls
      if(bird.y - bird.r < 0){ bird.y = bird.r; bird.vy = 0; }
      if(bird.y + bird.r > H - GROUND_H){ alive = false; }

      // collision with pipes
      for(const p of pipes){
        const pipeW = PIPE_W * PIPE_SCALE_X;
        const topRect = { x:p.x, y:0, w:pipeW, h:p.gapY };
        const botRect = { x:p.x, y:p.gapY + GAP_H, w:pipeW, h:H - GROUND_H - (p.gapY + GAP_H) };
        if(circleIntersectsRect(bird.x, bird.y, bird.r, topRect) ||
           circleIntersectsRect(bird.x, bird.y, bird.r, botRect)){
          alive = false; break;
        }
      }
    } else if(!alive){
      // trigger modal once when death detected
      if(!modal || !modal.classList.contains('hidden')){ /* already shown */ }
      else { showModal(score); }
    }
    frame++;
  }

  // ========= DRAWING =========
  function drawBackground(){
    const t = frame * 0.3;
    drawCloud((W - (t % (W+120))) - 120, 90, 1.0);
    drawCloud((W - ((t+200) % (W+160))) - 160, 160, 0.8);
  }
  function drawCloud(x,y,s){
    ctx.fillStyle='rgba(255,255,255,0.85)';
    ctx.beginPath();
    ctx.ellipse(x, y, 40*s, 24*s, 0, 0, Math.PI*2);
    ctx.ellipse(x+30*s, y-10*s, 30*s, 20*s, 0, 0, Math.PI*2);
    ctx.ellipse(x-30*s, y-8*s, 28*s, 18*s, 0, 0, Math.PI*2);
    ctx.fill();
  }

  function getPipeGradient(x){
    const g = ctx.createLinearGradient(x,0,x+PIPE_W,0);
    g.addColorStop(0,'#1e854e'); g.addColorStop(1,'#2ecc71');
    return g;
  }

  function drawPipes(){
    for(const p of pipes){
      const pipeW = PIPE_W * PIPE_SCALE_X;
      const topH = p.gapY;
      const botY = p.gapY + GAP_H;
      const botH = H - GROUND_H - botY;

      if (SPRITES.pipeReady) {
        // top (flip vertically)
        ctx.save(); ctx.translate(p.x + pipeW/2, topH/2); ctx.scale(1,-1);
        ctx.drawImage(SPRITES.pipe, -pipeW/2, -topH/2, pipeW, topH); ctx.restore();
        // bottom
        ctx.drawImage(SPRITES.pipe, p.x, botY, pipeW, botH);
      } else {
        ctx.fillStyle = getPipeGradient(p.x);
        ctx.fillRect(p.x, 0, pipeW, topH);
        ctx.fillStyle = 'rgba(0,0,0,.08)';
        ctx.fillRect(p.x-2, topH-10, pipeW+4, 10);
        ctx.fillStyle = getPipeGradient(p.x);
        ctx.fillRect(p.x, botY, pipeW, botH);
        ctx.fillStyle = 'rgba(0,0,0,.08)';
        ctx.fillRect(p.x-2, botY, pipeW+4, 10);
      }
    }
  }

  function drawBird(){
    ctx.save();
    ctx.translate(bird.x, bird.y);
    const tilt = Math.max(-0.6, Math.min(0.6, bird.vy/10));
    ctx.rotate(tilt);

    if (SPRITES.birdReady) {
      const w = (bird.r*2) * BIRD_SCALE;
      ctx.drawImage(SPRITES.bird, -w/2, -w/2, w, w);
    } else {
      // vector fallback
      ctx.fillStyle='#ffd166';
      ctx.beginPath(); ctx.arc(0,0,bird.r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = '#f4a261';
      ctx.beginPath(); ctx.ellipse(-2, 2, bird.r*0.7, bird.r*0.45, -0.5, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.arc(bird.r*0.35, -bird.r*0.28, bird.r*0.35, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#222';
      ctx.beginPath(); ctx.arc(bird.r*0.45, -bird.r*0.28, bird.r*0.16, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#ff9f1a';
      ctx.beginPath(); ctx.moveTo(bird.r*0.6, 0); ctx.lineTo(bird.r*1.2, -bird.r*0.1); ctx.lineTo(bird.r*0.6, bird.r*0.2); ctx.closePath(); ctx.fill();
    }
    ctx.restore();
  }

  function drawGround(){
    ctx.fillStyle='#3e4c59'; ctx.fillRect(0, H-GROUND_H, W, GROUND_H);
  }

  function drawHUD(){
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(8,8,112,56);
    ctx.fillStyle='#fff';
    ctx.font='bold 18px system-ui,-apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText('Score: '+score, 16, 32);
    ctx.fillText('Best:  '+best, 16, 56);

    if(!started){
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#fff';
      ctx.font='bold 26px system-ui,-apple-system, Segoe UI, Roboto, Arial';
      ctx.textAlign='center'; ctx.fillText('Tap / Click / Space to start', W/2, H/2 - 12);
      ctx.font='16px system-ui,-apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Fly through the gaps!', W/2, H/2 + 16); ctx.textAlign='left';
    }
    if(!alive){
      // darken behind, but the modal handles the UI
      ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fillRect(0,0,W,H);
    }
  }

  function render(){
    ctx.clearRect(0,0,W,H);
    drawBackground();
    drawPipes();
    drawBird();
    drawGround();
    drawHUD();
  }

  function loop(){
    update();
    render();
    requestAnimationFrame(loop);
  }

  // ========= INPUT =========
  document.addEventListener('keydown', (e)=>{
    if(e.code === 'Space'){ e.preventDefault(); flap(); }
    else if(e.code === 'ArrowUp'){ flap(); }
    else if(e.code === 'Enter'){ if(!alive){ reset(); } }
  });
  canvas.addEventListener('pointerdown', ()=>{ if(alive){ flap(); } });
  document.getElementById('flapBtn').addEventListener('click', flap);
  document.getElementById('restartBtn').addEventListener('click', reset);

  // Modal actions
  goSubmit.addEventListener('click', ()=> {
    const name = (goName.value||'').trim() || 'Anonymous';
    submitScore(name, score);
  });
  goSkip.addEventListener('click', ()=> { goStatus.textContent = 'Skipped.'; });
  goAgain.addEventListener('click', reset);

  // ========= START =========
  reset();
  loop();
  </script>
</body>
</html>
